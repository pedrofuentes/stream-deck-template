# Stream Deck Plugin — Template Instructions for AI Agents

You are scaffolding a new Stream Deck plugin. This document tells you exactly how to set it up, what patterns to follow, and what pitfalls to avoid. **Read LEARNINGS.md alongside this file** — it contains critical hardware-specific issues.

## Prerequisites

The user must have installed:
- Node.js >= 20
- Stream Deck CLI: `npm install -g @elgato/cli`
- Stream Deck software >= 6.9

## Step 1: Replace Placeholders

All scaffold files in this template use placeholder tokens. Replace them **everywhere** before writing any code:

| Placeholder | Replace With |
|---|---|
| `__PLUGIN_NAME__` | Human-readable name (e.g., `GitHub Utilities`) |
| `__PLUGIN_SLUG__` | Kebab-case (e.g., `github-utilities`) — used in npm name, filenames |
| `__PLUGIN_ID__` | Full UUID (e.g., `com.pedrofuentes.github-utilities`) |
| `__PLUGIN_DESCRIPTION__` | One-line description |
| `__AUTHOR_NAME__` | Full legal name for copyright |
| `__AUTHOR_EMAIL__` | Email for file headers |
| `__AUTHOR_SHORT__` | Display name for manifest |
| `__REPO_URL__` | GitHub repo URL |

## Step 2: Create Project Structure

```
<project-root>/
├── .copilot-instructions.md                    # Points to .github/AGENTS.md
├── .github/
│   ├── AGENTS.md                               # Agent instructions (customize from template)
│   ├── TESTING-PROTOCOL.md                     # Testing strategy, mocking, coverage, pre-release
│   └── UI-DESIGN-GUIDE.md                      # UI/UX patterns, SVG specs, accent bar, colors
├── .gitignore
├── LICENSE                                      # MIT license
├── CONTRIBUTING.md
├── README.md
├── package.json
├── package-lock.json                            # Generated by npm install
├── tsconfig.json
├── rollup.config.mjs
├── vitest.config.ts
├── src/
│   ├── plugin.ts                               # Entry point
│   ├── types.ts                                # Shared types
│   ├── actions/
│   │   └── <action-name>.ts                    # One file per action
│   └── utils/
│       ├── index.ts                            # Barrel exports
│       └── button-renderer.ts                  # SVG rendering
├── tests/
│   ├── actions/
│   │   └── <action-name>.test.ts
│   └── utils/
│       └── button-renderer.test.ts
└── __PLUGIN_ID__.sdPlugin/
    ├── manifest.json
    ├── .sdignore
    ├── imgs/
    │   ├── plugin-icon.png                     # 144×144 (MUST be PNG)
    │   ├── plugin-icon@2x.png                  # 288×288
    │   └── actions/
    │       └── <action-name>/
    │           ├── icon.png                    # 20×20 (MUST be PNG)
    │           ├── icon@2x.png                 # 40×40
    │           ├── key.png                     # 144×144
    │           └── key@2x.png                  # 288×288
    └── ui/
        ├── sdpi-components.js                  # Elgato UI component library
        └── <action-name>.html                  # Property inspector
```

## Step 3: Install Dependencies

```bash
npm install @elgato/streamdeck
npm install -D rollup @rollup/plugin-typescript @rollup/plugin-node-resolve \
    typescript tslib @types/node vitest @vitest/coverage-v8 \
    eslint @typescript-eslint/eslint-plugin @typescript-eslint/parser
```

## Step 4: Core Implementation Patterns

### Plugin Entry Point (`src/plugin.ts`)
```typescript
import streamDeck from "@elgato/streamdeck";
import { MyAction } from "./actions/my-action";

streamDeck.actions.registerAction(new MyAction());
streamDeck.connect();
```

### Action Class (`src/actions/<name>.ts`)
```typescript
import { action, KeyDownEvent, SingletonAction, WillAppearEvent, WillDisappearEvent, DidReceiveSettingsEvent, SendToPluginEvent } from "@elgato/streamdeck";
import streamDeck from "@elgato/streamdeck";

@action({ UUID: "__PLUGIN_ID__.<action-name>" })
export class MyAction extends SingletonAction<MySettings> {
    private timers = new Map<string, Timer>();

    override async onWillAppear(ev: WillAppearEvent<MySettings>): Promise<void> {
        await this.refresh(ev);
        const interval = ev.payload.settings.refreshInterval ?? 300;
        this.timers.set(ev.action.id, setInterval(() => this.refresh(ev), interval * 1000));
    }

    override async onWillDisappear(ev: WillDisappearEvent<MySettings>): Promise<void> {
        const timer = this.timers.get(ev.action.id);
        if (timer) clearInterval(timer);
        this.timers.delete(ev.action.id);
    }

    override async onKeyDown(ev: KeyDownEvent<MySettings>): Promise<void> {
        await this.refresh(ev); // press to refresh
    }
}
```

### SVG Button Rendering (`src/utils/button-renderer.ts`)
```typescript
// CRITICAL: Use this exact encoding — others DON'T work on hardware
export function renderKeyImage(options: KeyImageOptions): string {
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="144" height="144" viewBox="0 0 144 144">
        <rect width="144" height="144" rx="16" fill="#0d1117"/>
        <rect width="144" height="6" rx="3" fill="${options.accentColor}"/>
        <text x="72" y="80" text-anchor="middle" fill="#e6edf3"
              font-family="Arial,Helvetica,sans-serif" font-size="30" font-weight="bold">
            ${escapeXml(options.mainText)}
        </text>
    </svg>`;
    return "data:image/svg+xml," + encodeURIComponent(svg);
}
```

### Settings Types (`src/types.ts`)
```typescript
import type { JsonValue } from "@elgato/utils";

export interface GlobalSettings {
    apiToken?: string;
    [key: string]: JsonValue; // REQUIRED by SDK
}

export interface MySettings {
    someOption?: string;
    refreshInterval?: number;
    [key: string]: JsonValue; // REQUIRED by SDK
}
```

## Step 5: Testing

### Mock Pattern
```typescript
const mocks = vi.hoisted(() => ({
    setImage: vi.fn(),
    setTitle: vi.fn(),
    getGlobalSettings: vi.fn().mockResolvedValue({ apiToken: "test_token" }),
}));

vi.mock("@elgato/streamdeck", () => ({
    default: {
        settings: { getGlobalSettings: mocks.getGlobalSettings },
        actions: { registerAction: vi.fn() },
    },
}));
```

### What to Test
- All lifecycle handlers (onWillAppear, onWillDisappear, onKeyDown, onDidReceiveSettings)
- Error states (missing token, API errors, invalid settings)
- Timer cleanup on disappear
- SVG content assertions (decode with `decodeURIComponent`)
- Unconfigured state

## Step 6: Release

1. All icons must be PNG (not SVG) — validate with `streamdeck validate`
2. `npm run pack` — builds, tests, validates, and packages
3. Create GitHub release: `gh release create v1.0.0 release/*.streamDeckPlugin`
4. Update README badges (version, test count, license)

## Step 7: Contributing Learnings Back

This plugin was scaffolded from https://github.com/pedrofuentes/stream-deck-template. As you build, **periodically contribute new learnings back** so future plugins benefit:

1. Clone or open the template repo and write findings to `contributions/<plugin-slug>.md`
2. Commit and push (or open a PR) to the template repo: `docs(<plugin-slug>): add learnings about <topic>`
3. Before starting major work, pull and read the template repo's `LEARNINGS.md` for latest knowledge

Good moments to contribute: after solving a hardware quirk, implementing a reusable pattern, discovering a manifest constraint, completing a release, or when a session is wrapping up.

## Critical Rules

1. **SVG encoding**: `"data:image/svg+xml," + encodeURIComponent(svg)` — ONLY method that works on hardware
2. **No nested `<svg>`**: Use `<g transform="translate(x,y) scale(s)">` instead
3. **Icons must be PNG**: SVG icons fail `streamdeck validate`
4. **`ShowTitle: false`** inside manifest `States` entries; **`UserTitleEnabled: false`** at the **Action level** (NOT inside States)
5. **Always `setTitle("")`** after `setImage()` to clear default title overlay
6. **Settings need `[key: string]: JsonValue`** index signature
7. **Don't edit `bin/`** — it's generated by Rollup
8. **Image paths omit extensions** in manifest
9. **File headers** on every `.ts` file with `@author`, `@copyright`, `@license`
10. **Conventional commits**: `feat`, `fix`, `docs`, `test`, `chore`, etc.
11. **Contribute learnings** back to the template repo after significant discoveries
